import requests
import json
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import glob
import os
from tqdm import tqdm
import numpy as np

def get_ewas_gene_associations(gene):
    response_API = requests.get('https://ngdc.cncb.ac.cn/ewas/rest/gene?geneSymbol=%s' % gene)
    data = response_API.text
    probeList = json.loads(data)['data']['probeList']


    study_id_list = []
    trait_list = []
    correlation_list = []
    rank_list = []
    pmid_list = []
    probe_id_list = []
    chr_hg19_list = []
    pos_hg19_list = []

    for probe in probeList:
        probe_id = probe['probeId']
        chr_hg19 = probe['chrHg19']
        pos_hg19 = probe['posHg19']
        for association in probe['associationList']:
            probe_id_list.append(probe_id)
            chr_hg19_list.append(chr_hg19)
            pos_hg19_list.append(pos_hg19)
            study_id_list.append(association['studyId'])
            trait_list.append(association['trait'])
            correlation_list.append(association['correlation'])
            rank_list.append(association['rank'])
            pmid_list.append(association['pmid'])

    gene_associations = pd.DataFrame(
    {'probeId': probe_id_list,
     'chrHg19': chr_hg19_list,
     'posHg19': pos_hg19_list,
     'studyId': study_id_list,
     'trait': trait_list,
     'correlation': correlation_list,
     'rank': rank_list,
     'pmid': pmid_list
    })
    gene_associations['gene'] = [gene for x in range(len(gene_associations))]
    return gene_associations

gene_list = ["RP11-254I22.2","MFAP3","CTC-436K13.2","CTC-353G13.1","CCNJL","CEP72","WWC1","RP11-141O11.1","LINC01484","OSMR-AS1","C5orf60","OTULIN","SLC9A3","CTC-563A5.2","CTD-2152M20.2","AC011363.1","RNU6-760P","LMAN2","FAM159B","RP11-428C6.2","AC005592.3","RP11-443C10.1","HNRNPA0","TENM2","CTC-251D13.1","NCRUPAR_1","RP11-389C8.2","AC011357.1","RASGEF1C","CTD-2143L24.1","AC126917.1","MIR4636","GRAMD3","SEMA6A-AS1","CTB-129O4.1","CTD-2123J17.2","RP11-249M12.2","RP11-166A12.1","CTC-308K20.2","RP11-175K6.2","RP11-5N11.7","MCCC2","TNIP1","ARHGAP26-IT1","CXCL14","HEXB","PDE8B","RP11-267A15.3","PDE4D","ADAMTS2","LUCAT1","CTD-2287O16.4","PCSK1","HMHB1","TRAPPC13","MIR3936","SNCB","CTD-2210P15.3","SGTB","CTB-78F1.2","CTB-12O2.1","RNA5SP179","CTC-276P9.2","CTD-2207A17.1","SLC6A3","ISOC1","MIR4279","RNA5SP198","RPS14","TNFAIP8","EDIL3","CPLX2","FGFR4","RP11-1259L22.1","AC091878.1","AC008514.1","PTGER4","NPM1","CTD-2350J17.1","C5orf58","CTC-506B8.1","SNX24","RNU7-180P","ATG10","NRG2","NNT","CTB-3M24.2","WDR70","CKMT2-AS1","SCARNA18","LINC01170","ARSI","ADGRV1","FBXW11","FSTL4","HMGXB3","RP11-141O11.2","TRIM36-IT1","MAST4","CTD-2256P15.1","FAM134B","ERAP1","CTNND2","Metazoa_SRP","MXD3","FAM53C","RN7SL655P","BHMT2","RNU6-679P","CTD-2197I11.1","STK32A","GRXCR2","CTC-575N7.1","RP11-394O4.6","RNU6-484P","CTC-340A15.2","PRRC1","AC106801.1","CTD-2170G1.2","SYNPO","APBB3","CTD-2249K22.1","FOXI1","SDHA","CAMK4","CTD-2353F22.2","MIR874","CTB-26E19.1","RN7SL801P","JMY","CTC-529L17.1","ITGA2","RANBP17","MEGF10","GNPDA1","CTC-348L5.1","CTD-2175A23.1","SPINK14","AC008562.1","LCP2","LINC01023","CTD-2288O8.1","FYB","SPOCK1","LARS","ANKH","RP11-83M16.6","RP11-331K21.1","AC008592.7","MIR4637","CTC-367J11.1","ARHGEF28","VTRNA2-1","GPRIN1","CTD-2196P11.2","RN7SKP251","CTD-2363C16.1","CDC25C","MIR4459","RP11-118M9.3","LINC01411","UBTD2","CD180","uc_338","MIR579","ZNF354C","RP11-1379J22.2","CTB-4E7.1","SPINK5","SNORA70","NADK2","AC113404.1","NDST1","RP11-152K4.2","LINC01183","TTC37","RNU6-308P","EFNA5","SNX2","PHYKPL","SEMA6A","RNU6-358P","CENPK","MIR582","RP11-423H2.3","AFAP1L1","COL4A3BP","ANKDD1B","CTD-2154B17.3","ANKRA2","AC005740.6","C1QTNF2","FLJ33360","LINC01336","CTB-114C7.4","CTB-49A3.2","AC034243.1","RP11-83M16.5","SEMA5A","AC008949.1","BNIP1","HNCAT21","RP11-278J6.4","CTD-2270F17.1","GFM2","CTC-218H9.1","LINC01265","CTC-459M5.1","AC093304.1","RP11-122C5.3","SKP1","RP11-546B8.6","ZDHHC11","OXCT1","CTB-3M24.1","CTC-436P18.3","AC109465.1","CTC-265N9.1","JAKMIP2","CTD-2001E22.1","RP11-5N11.6","PRLR","AC106775.1","RNU6-923P","FABP6","GLRX","RAD1","RNU6-460P","RNU6-1330P","CTB-105N12.2","RP11-711G10.1","LINC01340","CTD-2117L12.1","RN7SKP34","CTB-37A13.1","RP11-2N5.2","UBE2QL1","SSBP2","RANBP3L","ITK","EXOC3","CTD-2050E21.1","GFPT2","CTC-534A2.2","MYO10","CTB-108O6.2","CWC27","CDH6","RP11-107N7.1","MAST4-AS1","AC022120.1","CTB-43P18.1","KLHL3","LINC01331","CTC-347C20.1","LRRC14B","TSSK1B","NME5","ADAMTS16","TTC33","SEPT8","ANXA6","PRR16","EGFLAM-AS2","JAKMIP2-AS1","RP11-375B1.2","STARD4-AS1","NREP","RNA5SP186","NIPBL","STARD4","ARSB","SLC38A9","C5orf45","CTC-321K16.1","NMUR2","AC005215.1","RNU6-209P","ACOT12","RP1-167G20.1","NSUN2","CTC-529G1.1","PPP2R2B","PART1","MIR378A","CTB-49A3.4","RP1-167G20.2","CTC-255N20.1","RP11-259O2.1","AC016656.1","EPB41L4A","CTD-2410N18.5","C9","CTC-430J12.2","RP11-136K7.1","CTC-303L1.2","DOCK2","RN7SL646P","RN7SL177P","CTC-207P7.1","RAB3C","C5orf66","ADAMTS12","CTB-118N6.2","PSD2","SCGB3A2","RP11-619L12.4","MCC","MCIDAS","ARL14EPL","RP11-414H23.2","CTD-2269F5.1","AC010297.1","CYFIP2","CTB-51A17.1","SNORA40","C5orf17","RP11-260E18.1","CCDC127","BRIX1","Clostridiales-1","CTB-178M22.2","ZNF366","COMMD10","SPRY4-IT1_1","MCTP1","RP11-541P9.3","PAPD4","CTC-461F20.1","RP11-542A14.1","CTD-2247C11.2","SPRY4","ARHGEF37","DNAH5","AC093267.1","MIR585","CTC-347C20.2","TNPO1","DROSHA","CTD-2363C16.2","CDX1","HMP19","RP11-54C4.3","RNU6-1003P","KIAA0825","CTD-2308B18.3","MAST4-IT1","MIR548AE2","PPP2R2B-IT1","SH3RF2","LIFR-AS1","RNA5SP180","SFXN1","CDH10","CTB-174D11.3","CTC-484P3.3","CTD-2236F14.1","RP11-423H2.4","FER","NR3C1","RP11-517I3.1","RN7SL378P","COL23A1","FNDC9","RNU6-47P","GCNT4","ELOVL7","AC011343.1","CTD-2201G3.1","CTD-2201E9.1","CTNNA1","RNU1-39P","CTD-2201E9.4","MARVELD2","TMEM174","LINC01187","AC005740.5","ENC1","AC025156.1","ZNF346","CTD-2023N9.1","AC020900.1","MIR378E","MAML1","SLC6A7","RP11-479O16.1","DMGDH","AC005355.3","RP11-116O11.1","CCDC69","SLC22A4","CTC-459M5.2","LARP1","CTD-2083E4.4","CTB-77H17.1","CTB-32P11.1","MEF2C","ANKHD1","RNU7-161P","CTD-2083E4.7","CTB-33O18.3","BDP1","F12","RN7SL174P","RNU6-660P","AC016577.1","CSF1R","UNC5A","SLC25A48","FBXL7","SCAMP1","CTB-17P3.4","PDCD6","SLC23A1","TIMD4","RNA5SP177","ARHGAP26","ARHGAP26-AS1","UTP15","MIR887","LNPEP","MIR143HG","RP11-542A14.2","U3","ATOX1","RP11-43D2.2","RN7SKP117","WSPAR","CDHR2","MARCH3","SV2C","SGCD","SNORD123","RP11-5N11.3","RAI14","RAD17","MAN2A1","DCP2","FGF18","CTB-174D11.1","AC010368.1","WDR36","RP11-526F3.1","ERGIC1","LINC01574","PP7080","TSPAN17","AC008780.1","ADAMTS6","CTD-2233C11.2","AC012613.2","CTD-2193P3.2","AC099512.1","MIR6499","RP11-536N17.1","LINC01485","JADE2","DPYSL3","MIR5003","CTB-147C13.1","FBLL1","ADRA1B","CTC-248O19.1","GHR","CMYA5","SLC1A3","SLIT3","CCNI2","AC074129.1","CTD-2215E18.1","CTD-2353F22.1","RP11-420O16.1","RP11-466P24.6","CTC-455F18.1","IQGAP2","H2AFY","CTD-2195M15.3","SRA1","CTD-2503O16.4","KCNIP1","ANKRD33B","HK3","XRCC4","RP11-375B1.1","PRDM6","RNU6-680P","ICE1","RP11-60A8.1","LECT2","CTD-2235C13.3","MIR218-2","RNU4-14P","PPARGC1B","AC005592.1","CTB-35F21.4","ZFR","RP11-524N5.1","CTB-174D11.2","MIR4633","LINC01470","CTB-181F24.1","CTC-366B18.4","RNU6-429P","RP11-60A8.2","AC010480.1","C1QTNF3","CTD-2260A17.1","EBF1","CAST","LINC01339","MIR5197","RN7SKP122","FAM196B","CTB-178M22.1","MIR4804","NSD1","C7","PARP8","TAS2R1","CTB-32H22.1","VCAN-AS1","RP11-119J18.1","BRD9","SMIM23","ABLIM3","HSD17B4","KCNMB1","CTD-2337A12.1","PLEKHG4B","CTB-1H10.1","CTB-47B11.3","FGF1","GALNT10","CTD-2297D10.1","RP11-436H11.5","ANKRD33B-AS1","RP11-1252I4.2","RP11-434D9.1","RARS","ZNF879","MAPK9","TCF7","RNU6-1079P","AC005592.2","PELO","AC122714.1","CTD-2228K2.7","LHFPL2","C5orf66-AS2","CLK4","RP11-317O24.1","CTD-2287O16.3","CTB-140J7.2","CTD-2116N24.1","RNU6-913P","GS1-39E22.1","CTC-276P9.3","KIF2A","EFCAB9","CTB-3M24.3","RP11-756H20.1","AC008674.1","RP11-508M8.1","LVRN","CTB-78F1.1","MIR581","CTC-209H22.3","ZNF354B","PAM","CTD-2296D1.5","CDH12","NSA2","AC010633.1","RP11-175K6.1","LINC01018","LTC4S","NDUFAF2","AC034236.1","NLN","CCNG1","CTC-575I10.1","RHOBTB3","STK10","ZDHHC11B","RP11-855C21.1","MRPS27","AC008781.7","FAT2","RP11-2O17.2","AC106786.1","CTC-229L21.1","RICTOR","CTB-36H16.2","CTD-2260A17.2","KIAA1024L","CTC-558O2.1","CTC-436P18.4","ITGA1","CTC-467M3.1","RNU4-69P","RN7SL623P","LPCAT1","CTC-558O19.1","Y_RNA","F2RL2","TBCA","RNA5SP190","AHRR","C5orf47","CTD-2201E9.3","AC109486.1","AC008967.1","SAP30L-AS1","RN7SL684P","CAMK2A","CTD-2281M20.1","KIAA0141","ADCY2","C5orf63","FLT4","GABRB2","CTB-105L4.2","RP11-348J24.1","CTC-431G16.2","AC011372.1","SH3PXD2B","RNA5SP199","ZBED3-AS1","CKMT2","FBXL17","UIMC1","BASP1","C6","ATP10B","RP11-2N5.1","AC022431.3","RNU6-588P","GABRG2","RBM27","C5orf67","CTD-2287O16.5","RPS23","SCGB3A1","HDAC3","RNU6-644P","RN7SL791P","IL3","RN7SKP230","RP11-619L12.3","RN7SL153P","AC025458.1","WDR41","RN7SKP60","RP11-133F8.2"]
associations_df = pd.DataFrame()
for gene in gene_list:
    try:
        temp_df = get_ewas_gene_associations(gene)
    except:
        continue
    associations_df = pd.concat([associations_df,  temp_df])
    
associations_df.to_csv('gene_associations_EWAS_ATLAS.bed', sep='\t', header=True, index=False)
associations_df
    